async function t(t){try{const e="localhost"===window.location.hostname?"http://localhost:3001":window.location.protocol+"//"+window.location.hostname,i=function(){if(window.parent&&window.parent!==window)try{const t=window.parent.discordUser;if(t&&t.username)return t.username}catch(t){console.log("Could not get Discord user info:",t)}return"Anonymous Player"}(),s=await fetch(`${e}/api/score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerName:i,score:t,level:1,gameType:"circus"})}),o=await s.json();return o.success?(console.log("Score submitted successfully:",o),window.parent.postMessage({type:"submitHighScore",score:t,playerName:i,success:!0},"*"),o):(console.error("Failed to submit score:",o),{success:!1,error:o.error})}catch(e){return console.error("Error submitting score:",e),window.parent.postMessage({type:"submitHighScore",score:t,success:!1,error:e.message},"*"),{success:!1,error:e.message}}}!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const e=10;let i=new Image,s=new Image,o=new Image,n=new Image;i.src="/assets/player.svg",s.src="/assets/trampoline.svg",o.src="/assets/balloon.svg",n.src="/assets/background.svg";let h=null,r=!1,c=null,a={isStarted:!0,isPlaying:!1,score:0,balloonsPopped:0,totalBalloons:30};class l{constructor(t,e){this.x=t,this.y=e,this.width=40,this.height=40,this.velocityX=0,this.velocityY=0,this.isJumping=!1}update(e){if(a.isStarted&&a.isPlaying){if(this.velocityY+=.5,this.x+=this.velocityX,this.y+=this.velocityY,this.y+this.height>e.y&&this.x+this.width>e.x&&this.x<e.x+e.width&&this.velocityY>0){const t=e.getBounceMultiplier(this.x+this.width/2);this.y=e.y-this.height,this.velocityY=-15*t,this.velocityX=.2*(this.x-(e.x+e.width/2)),this.isJumping=!0,function(){if(r&&h&&c)try{const t=h.createBufferSource();t.buffer=c,t.connect(h.destination),t.start(0)}catch(t){console.log("Bounce sound play failed:",t),r=!1}}()}this.x<0&&(this.x=0,this.velocityX*=-.5),this.x+this.width>g.width&&(this.x=g.width-this.width,this.velocityX*=-.5),this.y<0&&(this.y=0,this.velocityY*=-.7),this.y>g.height&&(a.isStarted=!1,f.textContent=a.score,m.style.display="flex",a.score>0&&t(a.score))}}draw(t){i.complete?t.drawImage(i,this.x,this.y,this.width,this.height):(t.fillStyle="#2ecc71",t.fillRect(this.x,this.y,this.width,this.height))}}class d{constructor(t,e){this.x=t,this.y=e,this.width=100,this.height=20,this.targetX=t,this.rotation=0,this.maxRotation=.2}update(){this.x+=.2*(this.targetX-this.x),this.x<0&&(this.x=0),this.x+this.width>g.width&&(this.x=g.width-this.width),this.rotation*=.9}draw(t){s.complete?(t.save(),t.translate(this.x+this.width/2,this.y+this.height/2),t.rotate(this.rotation),t.drawImage(s,-this.width/2,-this.height/2,this.width,this.height),t.restore()):(t.save(),t.translate(this.x+this.width/2,this.y+this.height/2),t.rotate(this.rotation),t.fillStyle="#3498db",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.restore())}getBounceMultiplier(t){const e=(t-this.x)/this.width,i=1+.5*(2*Math.abs(e-.5));return this.rotation=(e-.5)*this.maxRotation*2,i}}class u{constructor(t,e,i){this.x=t,this.y=e,this.width=40,this.height=50,this.isPopped=!1,this.speed=2,this.color=i,this.bounceBack="#f1c40f"===i?10:"#3498db"===i?8:"#e74c3c"===i?6:0}update(){this.isPopped||(this.x-=this.speed,this.x+this.width<0&&(this.x=g.width))}checkCollision(t){return!this.isPopped&&(t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y)}draw(t){if(!this.isPopped)if(o.complete){t.save();const e=document.createElement("canvas");e.width=this.width,e.height=this.height;const i=e.getContext("2d");i.drawImage(o,0,0,this.width,this.height),i.globalCompositeOperation="source-in",i.fillStyle=this.color,i.fillRect(0,0,this.width,this.height),t.drawImage(e,this.x,this.y),t.restore()}else t.fillStyle=this.color,t.beginPath(),t.arc(this.x+this.width/2,this.y+this.height/2,this.width/2,0,2*Math.PI),t.fill()}}const g=document.getElementById("gameCanvas"),y=g.getContext("2d"),w=document.getElementById("startScreen"),m=document.getElementById("gameOverScreen"),p=document.getElementById("score"),f=document.getElementById("finalScore"),x=document.getElementById("startButton"),v=document.getElementById("restartButton");function b(){const t=document.getElementById("gameContainer");g.width=t.clientWidth,g.height=t.clientHeight,P&&(P.x=g.width/2,P.y=g.height/2),S&&(S.x=g.width/2-S.width/2,S.y=g.height/2+100)}let P,S,E=[];async function B(){if(!h)try{h=new(window.AudioContext||window.webkitAudioContext);const t=await fetch("/assets/bounce.mp3"),e=await t.arrayBuffer();c=await h.decodeAudioData(e),console.log("Audio initialized successfully"),r=!0}catch(t){console.log("Audio initialization failed:",t),r=!1}}function I(){b(),B(),P=new l(g.width/2-20,g.height/2),S=new d(g.width/2-50,g.height/2+100),E=[];const t=g.width/11,e=["#e74c3c","#3498db","#f1c40f"];for(let i=0;i<3;i++){const s=g.width;for(let o=0;o<10;o++){const n=s+o*t,h=50+45*i;E.push(new u(n,h,e[i]))}}a.score=0,a.balloonsPopped=0,a.isStarted=!0,a.isPlaying=!1,p.textContent=`Score: ${a.score}`,w.style.display="none",m.style.display="none"}let C=!1;function A(t){t.preventDefault();const e=g.getBoundingClientRect(),i=t.touches[0].clientX-e.left;S.targetX=i-S.width/2}g.addEventListener("mousemove",t=>{if(!a.isStarted||!a.isPlaying)return;const e=g.getBoundingClientRect(),i=t.clientX-e.left;S.targetX=i-S.width/2}),g.addEventListener("touchstart",t=>{a.isStarted&&(C=!0,A(t))}),g.addEventListener("mouseup",t=>{a.isPlaying||(a.isPlaying=!0)}),g.addEventListener("touchmove",t=>{a.isStarted&&a.isPlaying&&C&&A(t)}),g.addEventListener("touchend",()=>{a.isPlaying?C=!1:a.isPlaying=!0}),B(),I(),function t(){y.clearRect(0,0,g.width,g.height),y.fillStyle="#34495e",y.fillRect(0,0,g.width,g.height),S.draw(y),a.isStarted?(S.update(),P.update(S),E.forEach(t=>t.update()),E.forEach(t=>{!t.isPopped&&t.checkCollision(P)&&(t.isPopped=!0,a.score+=10,a.balloonsPopped++,p.textContent=`Score: ${a.score}`,function(){if(r&&h)try{const t=h.createOscillator(),e=h.createGain();t.connect(e),e.connect(h.destination),t.type="sine",t.frequency.setValueAtTime(800,h.currentTime),t.frequency.exponentialRampToValueAtTime(100,h.currentTime+.1),e.gain.setValueAtTime(.3,h.currentTime),e.gain.exponentialRampToValueAtTime(.01,h.currentTime+.1),t.start(),t.stop(h.currentTime+.1)}catch(t){console.log("Sound play failed:",t),r=!1}}(),a.balloonsPopped===a.totalBalloons&&function(){E=[];const t=25,i=g.width/11,s=20,o=["#e74c3c","#3498db","#f1c40f"],n=50;for(let h=0;h<3;h++){const r=g.width;for(let c=0;c<e;c++){const e=r+c*i,a=n+h*(t+s);E.push(new u(e,a,o[h]))}}a.balloonsPopped=0,function(t,e=2e3){let i=document.getElementById("message");i||(i=document.createElement("div"),i.id="message",i.style.position="absolute",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.color="white",i.style.fontSize="24px",i.style.fontWeight="bold",i.style.textAlign="center",i.style.zIndex="20",i.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)",document.getElementById("gameContainer").appendChild(i));i.textContent=t,setTimeout(()=>{i.textContent=""},e)}("All balloons popped! New balloons added!")}())}),E.forEach(t=>t.draw(y)),P.draw(y),requestAnimationFrame(t)):requestAnimationFrame(t)}(),x.addEventListener("click",()=>{a.isPlaying=!0}),v.addEventListener("click",()=>{I(),a.isPlaying=!0}),window.addEventListener("resize",()=>{a.isStarted&&I()}),b();
